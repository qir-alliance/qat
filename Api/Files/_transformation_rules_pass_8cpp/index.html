<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
     
    <meta name="author" content="troels" />
     
    <link rel="canonical" href="https://qir-alliance.github.io/qat/Api/Files/_transformation_rules_pass_8cpp/" />
     
    <link rel="shortcut icon" href="../../../img/favicon.ico" />
    
    <title>
      TransformationRulesPass/TransformationRulesPass.cpp - QAT Documentation
    </title>
    <link href="../../../css/styles.css" rel="stylesheet" />
    <link href="../../../css/font-awesome.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/monokai-sublime.min.css"
    />
    <link href="../../../css/quantum-colors.css" rel="stylesheet" />

    <script src="../../../js/jquery-1.10.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/llvm.min.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>  
  </head>

  <body>
    <div class="h-screen flex overflow-hidden bg-white">
      <!-- Off-canvas menu for mobile, show/hide based on off-canvas menu state. -->
      <div class="lg:hidden hidden" id="sidebar">
        <div class="fixed inset-0 flex z-40">
          <!--
        Off-canvas menu overlay, show/hide based on off-canvas menu state.

        Entering: "transition-opacity ease-linear duration-300"
          From: "opacity-0"
          To: "opacity-100"
        Leaving: "transition-opacity ease-linear duration-300"
          From: "opacity-100"
          To: "opacity-0"
      -->
          <div class="fixed inset-0" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-600 opacity-75"></div>
          </div>
          <!--
        Off-canvas menu, show/hide based on off-canvas menu state.

        Entering: "transition ease-in-out duration-300 transform"
          From: "-translate-x-full"
          To: "translate-x-0"
        Leaving: "transition ease-in-out duration-300 transform"
          From: "translate-x-0"
          To: "-translate-x-full"
      -->
          <div
            class="relative flex-1 flex flex-col max-w-xs w-full pt-5 pb-4 bg-gray-800"
          >
            <div class="absolute top-0 right-0 -mr-12 pt-2">
              <button
                class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
                id="sidebarClose"                
              >
                <span class="sr-only">Close sidebar</span>
                <!-- Heroicon name: x -->
                <svg
                  class="h-6 w-6 text-white"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
            <div class="flex flex-col justify-center items-center flex-shrink-0 px-4">
<svg
   class="h-16 w-16"
   id="outputsvg"
   width="302.20001"
   height="292.73355"
   viewBox="0 0 3022.0001 2927.3355"
   version="1.1"
   sodipodi:docname="93013746.svg"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs40" />
  <sodipodi:namedview
     id="namedview38"
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1.0"
     showgrid="false"
     fit-margin-top="0"
     fit-margin-left="0"
     fit-margin-right="0"
     fit-margin-bottom="0" />
  <g
     id="l3qWAVepmhNjXiGFCK8Ygm8"
     fill="#ffffff"
     transform="translate(-510,-500.49862)">
    <g
       id="g26">
      <path
         id="powjCKlys"
         d="M 890,2694 C 709,2646 609,2553 549,2375 l -24,-70 V 1605 905 l 27,-72 c 30,-83 86,-171 130,-208 16,-14 68,-44 114,-66 109,-53 228,-69 391,-52 92,9 120,16 186,49 103,49 166,107 204,186 58,119 65,152 71,326 4,133 7,162 18,158 10,-4 14,2 14,19 0,21 -13,30 -85,65 l -85,41 v 263 264 l 28,7 c 15,4 52,19 82,33 44,22 56,33 58,55 3,21 0,26 -12,21 -14,-5 -16,10 -16,127 0,211 -28,301 -115,378 -20,18 -36,34 -34,36 2,2 45,9 94,17 l 90,13 3,73 3,72 -373,-1 c -295,0 -385,-3 -428,-15 z m 327,-275 c 46,-26 87,-82 106,-144 9,-30 12,-201 12,-665 0,-592 -1,-628 -19,-684 -35,-105 -112,-158 -230,-157 -118,0 -203,62 -237,171 -19,63 -19,92 -17,690 l 3,625 26,56 c 28,59 76,105 131,126 54,21 175,11 225,-18 z" />
      <path
         id="pXDrvybHy"
         d="m 2410,2340 c 0,-333 -2,-369 -16,-363 -12,4 -15,0 -12,-18 3,-24 15,-32 101,-69 l 47,-21 v -259 -259 l -75,-35 c -64,-30 -75,-38 -75,-60 0,-18 4,-24 15,-20 13,5 15,-36 15,-340 V 550 h 378 c 427,0 466,5 559,67 70,46 125,130 150,227 15,58 18,111 18,296 0,252 -9,305 -65,376 -36,45 -132,112 -172,121 -34,7 -37,23 -5,23 12,1 47,13 77,29 63,31 122,101 140,165 7,25 15,180 20,400 5,197 11,380 15,407 l 7,49 h -155 -155 l -6,-32 c -3,-18 -8,-190 -11,-383 -8,-429 -12,-446 -120,-496 -34,-16 -66,-19 -207,-19 h -168 v 465 465 h -150 -150 z m 695,-864 c 28,-8 48,-24 70,-55 l 30,-43 v -201 c 0,-349 -25,-377 -337,-377 h -158 v 345 345 l 178,-1 c 106,0 193,-5 217,-13 z" />
    </g>
  </g>
  <g
     id="l6geLyeKy0gshdvsOIcFawK"
     fill="#14775d"
     transform="translate(-510,-500.49862)">
    <g
       id="g30">
      <path
         id="pFwHav8Wh"
         d="m 1830,2411 v -299 l -46,-38 c -78,-65 -217,-144 -281,-160 l -23,-6 v -293 -293 l 103,-52 c 57,-28 134,-75 173,-104 l 69,-53 3,-281 2,-282 h 38 c 20,0 61,-3 90,-6 48,-6 52,-5 52,15 0,12 -6,21 -15,21 -13,0 -15,38 -15,278 0,261 1,279 20,312 11,19 28,52 38,72 9,20 25,39 35,42 12,3 17,14 17,36 0,29 -2,31 -17,19 -10,-7 -25,-22 -34,-33 -17,-19 -18,-19 -73,31 -61,56 -126,102 -187,134 l -40,20 3,122 3,122 45,24 c 25,14 78,50 119,80 41,31 82,62 93,70 16,12 21,11 41,-8 31,-28 37,-27 37,9 0,17 9,48 20,70 19,37 20,59 20,385 v 345 h -145 -145 z" />
    </g>
  </g>
  <g
     id="ls88IYZfP5b5b8x7RYseij"
     fill="#1cb78e"
     transform="translate(-510,-500.49862)">
    <g
       id="g34">
      <path
         id="pCM7FVo6B"
         d="m 2090,2378 v -333 l -31,-55 c -25,-46 -28,-58 -18,-76 14,-27 124,-110 197,-149 l 52,-28 v -122 -122 l -76,-48 c -98,-62 -176,-134 -222,-204 l -37,-56 -3,-317 c -3,-300 -2,-318 15,-319 17,-1 190,-1 226,0 16,1 17,21 17,271 0,235 2,274 17,296 23,36 123,104 236,159 l 97,48 -2,289 -3,289 -60,27 c -102,46 -195,102 -241,146 l -44,43 v 296 297 h -60 -60 z" />
    </g>
  </g>
</svg>


  <span class="text-white">Adaptor Tool</span>
</div>
            <div class="mt-5 flex-1 h-0 overflow-y-auto">
              <nav class="px-2">
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                User guide
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../UserGuide/QuickStart/"
                >Quick start</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../UserGuide/BuildingLibrary/"
                >Building the library</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../UserGuide/IntroductionToProfiles/"
                >Introduction to profiles</a
              > 
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                Developer guide
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/ArchitectureOverview/"
                >Architecture Overview</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/WritingComponent/"
                >Writing a Component</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/ConfigurationLibrary/"
                >Configuration Library</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/WritingRuleTests/"
                >Rule based extensions</a
              > 
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                Api
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Classes/"
                >Classes</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Namespaces/"
                >Namespaces</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Modules/"
                >Modules</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../"
                >Files</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Pages/"
                >Pages</a
              > 
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                Contributing
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/CodeQuality/"
                >Code quality</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/DeveloperFAQ/"
                >Developer FAQ</a
              > 

              </nav>
            </div>
          </div>
          <div class="flex-shrink-0 w-14" aria-hidden="true">
            <!-- Dummy element to force sidebar to shrink to fit close icon -->
          </div>
        </div>
      </div>

      <!-- Static sidebar for desktop -->
      <div class="hidden lg:flex lg:flex-shrink-0">
        <div
          class="flex flex-col w-64 border-r border-gray-200 pt-5 pb-4 bg-gray-800"
        >
          <div class="flex flex-col justify-center items-center flex-shrink-0 px-4">
<svg
   class="h-16 w-16"
   id="outputsvg"
   width="302.20001"
   height="292.73355"
   viewBox="0 0 3022.0001 2927.3355"
   version="1.1"
   sodipodi:docname="93013746.svg"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs40" />
  <sodipodi:namedview
     id="namedview38"
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1.0"
     showgrid="false"
     fit-margin-top="0"
     fit-margin-left="0"
     fit-margin-right="0"
     fit-margin-bottom="0" />
  <g
     id="l3qWAVepmhNjXiGFCK8Ygm8"
     fill="#ffffff"
     transform="translate(-510,-500.49862)">
    <g
       id="g26">
      <path
         id="powjCKlys"
         d="M 890,2694 C 709,2646 609,2553 549,2375 l -24,-70 V 1605 905 l 27,-72 c 30,-83 86,-171 130,-208 16,-14 68,-44 114,-66 109,-53 228,-69 391,-52 92,9 120,16 186,49 103,49 166,107 204,186 58,119 65,152 71,326 4,133 7,162 18,158 10,-4 14,2 14,19 0,21 -13,30 -85,65 l -85,41 v 263 264 l 28,7 c 15,4 52,19 82,33 44,22 56,33 58,55 3,21 0,26 -12,21 -14,-5 -16,10 -16,127 0,211 -28,301 -115,378 -20,18 -36,34 -34,36 2,2 45,9 94,17 l 90,13 3,73 3,72 -373,-1 c -295,0 -385,-3 -428,-15 z m 327,-275 c 46,-26 87,-82 106,-144 9,-30 12,-201 12,-665 0,-592 -1,-628 -19,-684 -35,-105 -112,-158 -230,-157 -118,0 -203,62 -237,171 -19,63 -19,92 -17,690 l 3,625 26,56 c 28,59 76,105 131,126 54,21 175,11 225,-18 z" />
      <path
         id="pXDrvybHy"
         d="m 2410,2340 c 0,-333 -2,-369 -16,-363 -12,4 -15,0 -12,-18 3,-24 15,-32 101,-69 l 47,-21 v -259 -259 l -75,-35 c -64,-30 -75,-38 -75,-60 0,-18 4,-24 15,-20 13,5 15,-36 15,-340 V 550 h 378 c 427,0 466,5 559,67 70,46 125,130 150,227 15,58 18,111 18,296 0,252 -9,305 -65,376 -36,45 -132,112 -172,121 -34,7 -37,23 -5,23 12,1 47,13 77,29 63,31 122,101 140,165 7,25 15,180 20,400 5,197 11,380 15,407 l 7,49 h -155 -155 l -6,-32 c -3,-18 -8,-190 -11,-383 -8,-429 -12,-446 -120,-496 -34,-16 -66,-19 -207,-19 h -168 v 465 465 h -150 -150 z m 695,-864 c 28,-8 48,-24 70,-55 l 30,-43 v -201 c 0,-349 -25,-377 -337,-377 h -158 v 345 345 l 178,-1 c 106,0 193,-5 217,-13 z" />
    </g>
  </g>
  <g
     id="l6geLyeKy0gshdvsOIcFawK"
     fill="#14775d"
     transform="translate(-510,-500.49862)">
    <g
       id="g30">
      <path
         id="pFwHav8Wh"
         d="m 1830,2411 v -299 l -46,-38 c -78,-65 -217,-144 -281,-160 l -23,-6 v -293 -293 l 103,-52 c 57,-28 134,-75 173,-104 l 69,-53 3,-281 2,-282 h 38 c 20,0 61,-3 90,-6 48,-6 52,-5 52,15 0,12 -6,21 -15,21 -13,0 -15,38 -15,278 0,261 1,279 20,312 11,19 28,52 38,72 9,20 25,39 35,42 12,3 17,14 17,36 0,29 -2,31 -17,19 -10,-7 -25,-22 -34,-33 -17,-19 -18,-19 -73,31 -61,56 -126,102 -187,134 l -40,20 3,122 3,122 45,24 c 25,14 78,50 119,80 41,31 82,62 93,70 16,12 21,11 41,-8 31,-28 37,-27 37,9 0,17 9,48 20,70 19,37 20,59 20,385 v 345 h -145 -145 z" />
    </g>
  </g>
  <g
     id="ls88IYZfP5b5b8x7RYseij"
     fill="#1cb78e"
     transform="translate(-510,-500.49862)">
    <g
       id="g34">
      <path
         id="pCM7FVo6B"
         d="m 2090,2378 v -333 l -31,-55 c -25,-46 -28,-58 -18,-76 14,-27 124,-110 197,-149 l 52,-28 v -122 -122 l -76,-48 c -98,-62 -176,-134 -222,-204 l -37,-56 -3,-317 c -3,-300 -2,-318 15,-319 17,-1 190,-1 226,0 16,1 17,21 17,271 0,235 2,274 17,296 23,36 123,104 236,159 l 97,48 -2,289 -3,289 -60,27 c -102,46 -195,102 -241,146 l -44,43 v 296 297 h -60 -60 z" />
    </g>
  </g>
</svg>


  <span class="text-white">Adaptor Tool</span>
</div>

          <!-- Sidebar component, swap this element with another sidebar if you like -->
          <div class="h-0 flex-1 flex flex-col overflow-y-auto">
            <!-- Navigation -->
            <nav class="mt-2 flex-1 px-2 bg-gray-800">
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                User guide
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../UserGuide/QuickStart/"
                >Quick start</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../UserGuide/BuildingLibrary/"
                >Building the library</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../UserGuide/IntroductionToProfiles/"
                >Introduction to profiles</a
              > 
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                Developer guide
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/ArchitectureOverview/"
                >Architecture Overview</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/WritingComponent/"
                >Writing a Component</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/ConfigurationLibrary/"
                >Configuration Library</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/WritingRuleTests/"
                >Rule based extensions</a
              > 
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                Api
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Classes/"
                >Classes</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Namespaces/"
                >Namespaces</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Modules/"
                >Modules</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../"
                >Files</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../Pages/"
                >Pages</a
              > 
              <h3
                class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-8 mb-1"
                id="teams-headline"
              >
                Contributing
              </h3>
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/CodeQuality/"
                >Code quality</a
              >
              <a
                class=" hover:bg-gray-700 text-gray-300 hover:text-white group flex items-center px-2 py-4 text-sm font-medium rounded"
                href="../../../DeveloperGuide/DeveloperFAQ/"
                >Developer FAQ</a
              > 
            </nav>
          </div>
        </div>
      </div>

      <!-- Main column -->
      <div class="flex flex-col w-0 flex-1 overflow-hidden">

        <!-- Top bar -->
        <div
          class="relative z-20 flex-shrink-0 flex h-16 bg-white border-b border-gray-200 focus:outline-none"
        >
          <button
            class="px-4 border-r border-gray-200 text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-cyan-500 lg:hidden"
            id="sidebarOpen"                            
          >
            <span class="sr-only">Open sidebar</span>
            <!-- Heroicon name: menu-alt-1 -->
            <svg
              class="h-6 w-6"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h8m-8 6h16"
              />
            </svg>
          </button>

          <div
            class="flex-1 px-4 flex justify-between sm:px-6 lg:max-w-6xl lg:mx-auto lg:px-8"
          >
            <div class="flex-1 flex">
              <form class="w-full flex md:ml-0" action="#" method="GET">
                <label for="mkdocs-search-query" class="sr-only">Search</label>
                <div
                  class="relative w-full text-gray-400 focus-within:text-gray-600"
                >
                  <div
                    class="absolute inset-y-0 left-0 flex items-center pointer-events-none"
                    aria-hidden="true"
                  >
                    <!-- Heroicon name: search -->
                    <svg
                      class="h-5 w-5"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      aria-hidden="true"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <input
                    id="mkdocs-search-query"
                    name="mkdocs-search-query"
                    class="block w-full h-full pl-8 pr-3 py-2 border-transparent text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-0 focus:border-transparent sm:text-sm"
                    placeholder="Search documentation"
                    type="search"
                  />       
                </div>
              </form>
              <div id="searchResults" class="fixed sm:absolute mt-16 z-10 inset-0 overflow-y-auto min-h-screen min-w-screen flex flex-col justify-start sm:pb-16 lg:pb-96 lg:max-w-6xl lg:mx-auto hidden">
                  <div class="bg-gray-100 text-gray-400 p-2">
                    Results
                  </div>
                  <div class="bg-white min-h-96 z-100 p-4 sm:p-8 rounded-b space-y-4 flex flex-col overflow-y-auto w-full max-h-full">
                    <div class="prose"  id="mkdocs-search-results">
                    </div>
                  </div>
              </div>                         
            </div>
            
          </div>
        </div>

        <main
          class="relative flex flex-col flex-grow h-0 min-h-full justify-between bg-white focus:outline-none overflow-y-auto scrollbar-thumb-blue scrollbar-thumb-rounded scrollbar-track-blue-lighter scrollbar-w-2 scrolling-touch"
          tabindex="0"
        >

        <div class="fixed inset-0 transition-opacity hidden searchOverlayElement" aria-hidden="true" id="searchOverlay">
          <div class="absolute inset-0 bg-gray-500 opacity-75 searchOverlayElement"></div>
        </div>

          <div
            class="lg:px-8 flex flex-col space-y-4 p-4 md:px-6 sm:px-8 w-full mb-96"
          > 

            



<div class="lg:max-w-6xl w-full lg:mx-auto px-4 sm:px-6 lg:px-8">
  <div class="text-lg max-w-prose mx-auto  py-10">
    <h1>
      <span class="block text-base text-center text-qauntum-600 font-semibold tracking-wide uppercase">
        Documentation for
      </span>
      <span class="mt-2 block text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl flex flex-row justify-center">
        <span class="text-center">
          TransformationRulesPass/TransformationRulesPass.cpp
        </span>
      </span>
    </h1>
    
  </div>
  <div class="mt-6 text-gray-500 mx-auto blog-lg blog">
    <h1 id="transformationrulespasstransformationrulespasscpp">TransformationRulesPass/TransformationRulesPass.cpp</h1>
<h2 id="namespaces">Namespaces</h2>
<table>
<thead>
<tr>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><a href="/qat/Api/Namespaces/namespacemicrosoft/">microsoft</a></strong></td>
</tr>
<tr>
<td><strong><a href="/qat/Api/Namespaces/namespacemicrosoft_1_1quantum/">microsoft::quantum</a></strong></td>
</tr>
</tbody>
</table>
<h2 id="source-code">Source code</h2>
<pre><code class="language-cpp">// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.

#include &quot;Rules/Factory.hpp&quot;
#include &quot;Rules/Notation/Notation.hpp&quot;
#include &quot;Rules/ReplacementRule.hpp&quot;
#include &quot;TransformationRulesPass/TransformationRulesPass.hpp&quot;

#include &quot;Llvm/Llvm.hpp&quot;

#include &lt;fstream&gt;
#include &lt;iostream&gt;

namespace microsoft
{
namespace quantum
{

    TransformationRulesPass::TransformationRulesPass(
        RuleSet&amp;&amp;                                   rule_set,
        TransformationRulesPassConfiguration const&amp; config,
        Profile*                                    profile)
      : rule_set_{std::move(rule_set)}
      , config_{config}
      , profile_{profile}
    {
    }

    void TransformationRulesPass::setupCopyAndExpand()
    {
        using namespace microsoft::quantum::notation;
        addConstExprRule(
            {branch(&quot;cond&quot;_cap = constInt(), &quot;if_false&quot;_cap = _, &quot;if_true&quot;_cap = _),
             [](Builder&amp; builder, Value* val, Captures&amp; captures, Replacements&amp; replacements) {
                 auto cst   = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(captures[&quot;cond&quot;]);
                 auto instr = llvm::dyn_cast&lt;llvm::Instruction&gt;(val);

                 if (cst == nullptr || instr == nullptr)
                 {
                     return false;
                 }

                 auto type = instr-&gt;getType();
                 if (type == nullptr)
                 {
                     return false;
                 }

                 auto branch_cond = cst-&gt;getValue().getZExtValue();

                 if (branch_cond)
                 {
                     auto if_true = llvm::dyn_cast&lt;llvm::BasicBlock&gt;(captures[&quot;if_true&quot;]);

                     builder.CreateBr(if_true);
                     instr-&gt;replaceAllUsesWith(llvm::UndefValue::get(type));
                 }
                 else
                 {
                     auto if_false = llvm::dyn_cast&lt;llvm::BasicBlock&gt;(captures[&quot;if_false&quot;]);

                     builder.CreateBr(if_false);
                     instr-&gt;replaceAllUsesWith(llvm::UndefValue::get(type));
                 }

                 replacements.push_back({val, nullptr});

                 return true;
             }});

        if (config_.assumeNoExceptions())
        {
            // Replacing all invokes with calls
            addConstExprRule({unnamedInvoke(), [](Builder&amp; builder, Value* val, Captures&amp;, Replacements&amp; replacements) {
                                  auto invoke = llvm::dyn_cast&lt;llvm::InvokeInst&gt;(val);
                                  if (invoke == nullptr)
                                  {
                                      return false;
                                  }

                                  auto callee_function = invoke-&gt;getCalledFunction();

                                  // List with new call arguments
                                  std::vector&lt;llvm::Value*&gt; new_arguments;
                                  for (unsigned i = 0; i &lt; invoke-&gt;getNumArgOperands(); ++i)
                                  {
                                      // Getting the i'th argument
                                      llvm::Value* arg = invoke-&gt;getArgOperand(i);

                                      new_arguments.push_back(arg);
                                  }

                                  // Creating a new call
                                  auto* new_call = builder.CreateCall(callee_function, new_arguments);
                                  builder.CreateBr(invoke-&gt;getNormalDest());

                                  new_call-&gt;takeName(invoke);

                                  // Replace all calls to old function with calls to new function
                                  invoke-&gt;replaceAllUsesWith(new_call);
                                  replacements.push_back({invoke, nullptr});
                                  return true;
                              }});
        }
    }

    void TransformationRulesPass::addConstExprRule(ReplacementRule&amp;&amp; rule)
    {
        auto ret = std::make_shared&lt;ReplacementRule&gt;(std::move(rule));

        const_expr_replacements_.addRule(ret);
    }

    void TransformationRulesPass::constantFoldFunction(llvm::Function&amp; fnc)
    {
        std::vector&lt;llvm::Instruction*&gt; to_delete;

        // Folding all constants
        for (auto&amp; basic_block : fnc)
        {

            for (auto&amp; instr : basic_block)
            {
                auto        module = instr.getModule();
                auto const&amp; dl     = module-&gt;getDataLayout();
                auto        cst    = llvm::ConstantFoldInstruction(&amp;instr, dl, nullptr);
                if (cst != nullptr)
                {
                    instr.replaceAllUsesWith(cst);
                    to_delete.push_back(&amp;instr);
                }
            }
        }

        // Deleting constants
        for (auto&amp; x : to_delete)
        {
            x-&gt;eraseFromParent();
        }

        // Folding constant expressions
        Replacements replacements;
        for (auto&amp; basic_block : fnc)
        {
            for (auto&amp; instr : basic_block)
            {

                const_expr_replacements_.matchAndReplace(&amp;instr, replacements);
            }
        }

        for (auto&amp; r : replacements)
        {
            if (r.second != nullptr)
            {
                throw std::runtime_error(&quot;Real replacements not implemented.&quot;);
            }
            auto instr = llvm::dyn_cast&lt;llvm::Instruction&gt;(r.first);
            if (instr != nullptr)
            {
                instr-&gt;eraseFromParent();
                continue;
            }

            auto block = llvm::dyn_cast&lt;llvm::BasicBlock&gt;(r.first);
            if (block != nullptr)
            {
                llvm::DeleteDeadBlock(block);
            }
        }
    }

    llvm::Value* TransformationRulesPass::copyAndExpand(
        llvm::Value*           input,
        DeletableInstructions&amp; schedule_instruction_deletion)
    {
        llvm::Value* ret        = input;
        auto*        call_instr = llvm::dyn_cast&lt;llvm::CallInst&gt;(input);
        auto         instr_ptr  = llvm::dyn_cast&lt;llvm::Instruction&gt;(input);
        if (call_instr != nullptr &amp;&amp; instr_ptr != nullptr)
        {
            auto&amp; instr = *instr_ptr;

            auto callee_function = call_instr-&gt;getCalledFunction();
            if (callee_function != nullptr &amp;&amp; !callee_function-&gt;isDeclaration())
            {
                ConstantArguments     argument_constants{};
                std::vector&lt;uint32_t&gt; remaining_arguments{};

                uint32_t idx = 0;
                auto     n   = static_cast&lt;uint32_t&gt;(callee_function-&gt;arg_size());

                // Finding argument constants
                while (idx &lt; n)
                {
                    auto arg   = callee_function-&gt;getArg(idx);
                    auto value = call_instr-&gt;getArgOperand(idx);

                    auto cst = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(value);
                    if (cst != nullptr)
                    {
                        argument_constants[arg-&gt;getName().str()] = cst;
                    }
                    else
                    {
                        remaining_arguments.push_back(idx);
                    }

                    ++idx;
                }

                // Making a function copy
                auto new_callee = expandFunctionCall(*callee_function, argument_constants);

                // Replacing call if a new function was created
                if (new_callee != nullptr)
                {

                    llvm::IRBuilder&lt;&gt; builder(call_instr);

                    // List with new call arguments
                    std::vector&lt;llvm::Value*&gt; new_arguments;
                    for (auto const&amp; i : remaining_arguments)
                    {
                        // Getting the i'th argument
                        llvm::Value* arg = call_instr-&gt;getArgOperand(i);

                        // Adding arguments that were not constant
                        if (argument_constants.find(arg-&gt;getName().str()) == argument_constants.end())
                        {
                            new_arguments.push_back(arg);
                        }
                    }

                    // Creating a new call
                    auto* new_call = builder.CreateCall(new_callee, new_arguments);
                    new_call-&gt;takeName(call_instr);
                    new_call-&gt;setTailCall(call_instr-&gt;isTailCall());
                    new_call-&gt;setTailCallKind(call_instr-&gt;getTailCallKind());
                    if (call_instr-&gt;canReturnTwice())
                    {
                        new_call-&gt;setCanReturnTwice();
                    }

                    new_call-&gt;setCallingConv(call_instr-&gt;getCallingConv());
                    new_call-&gt;setAttributes(call_instr-&gt;getAttributes());

                    // Replace all calls to old function with calls to new function
                    instr.replaceAllUsesWith(new_call);

                    // Deleting instruction
                    schedule_instruction_deletion.push_back(&amp;instr);

                    // Folding constants in the new function as we may have replaced some of
                    // the arguments with constants
                    constantFoldFunction(*new_callee);

                    // Recursion: Returning the new call as the instruction to be analysed
                    ret = new_call;
                }

                // Deleting the function the original function if it is no longer in use
                if (callee_function-&gt;use_empty())
                {
                    callee_function-&gt;eraseFromParent();
                }
            }
        }

        return ret;
    }

    llvm::Value* TransformationRulesPass::detectActiveCode(llvm::Value* input, DeletableInstructions&amp;)
    {
        active_pieces_.insert(input);
        return input;
    }

    bool TransformationRulesPass::runOnFunction(llvm::Function&amp; function, InstructionModifier const&amp; modifier)
    {
        if (function.isDeclaration())
        {
            return false;
        }

        if (depth_ &gt;= config_.maxRecursion())
        {
            llvm::outs() &lt;&lt; &quot;Exceed max recursion of &quot; &lt;&lt; config_.maxRecursion() &lt;&lt; &quot;\n&quot;;
            return false;
        }
        ++depth_;

        // Keep track of instructions scheduled for deletion
        DeletableInstructions schedule_instruction_deletion;

        // Block queue
        std::deque&lt;llvm::BasicBlock*&gt;         queue;
        std::unordered_set&lt;llvm::BasicBlock*&gt; blocks_queued;
        queue.push_back(&amp;function.getEntryBlock());
        blocks_queued.insert(&amp;function.getEntryBlock());

        // Executing the modifier on the function itsel
        modifier(&amp;function, schedule_instruction_deletion);

        while (!queue.empty())
        {
            auto&amp; basic_block = *(queue.front());
            queue.pop_front();

            // Executing the modifier on the block
            modifier(&amp;basic_block, schedule_instruction_deletion);

            for (auto&amp; instr : basic_block)
            {
                // Modifying instruction as needed
                auto instr_ptr = modifier(&amp;instr, schedule_instruction_deletion);

                // In case the instruction was scheduled for deletion
                if (instr_ptr == nullptr)
                {
                    continue;
                }

                // Checking if we are calling a function
                auto call_instr = llvm::dyn_cast&lt;llvm::CallBase&gt;(instr_ptr);
                if (call_instr != nullptr)
                {
                    auto callee_function = call_instr-&gt;getCalledFunction();
                    if (callee_function != nullptr &amp;&amp; !callee_function-&gt;isDeclaration())
                    {
                        runOnFunction(*callee_function, modifier);
                    }
                }

                // Following the branches to their basic blocks
                auto* br_instr = llvm::dyn_cast&lt;llvm::BranchInst&gt;(&amp;instr);
                if (br_instr != nullptr)
                {
                    for (uint32_t i = 0; i &lt; br_instr-&gt;getNumOperands(); ++i)
                    {
                        // TODO(issue-19): This may not work on multi path branches (conditional)
                        // as we may accidentally add the final path (contains qubit release)
                        // and we cannot make assumptions since optimisation may have rearranged
                        // everything. In this case, we should revert to the order they appear in the
                        // function
                        auto bb = llvm::dyn_cast&lt;llvm::BasicBlock&gt;(br_instr-&gt;getOperand(i));
                        if (bb != nullptr)
                        {

                            // Ensuring that we are not scheduling the same block twice
                            if (blocks_queued.find(bb) == blocks_queued.end())
                            {
                                queue.push_back(bb);
                                blocks_queued.insert(bb);
                            }
                        }
                    }
                    continue;
                }

                // Follow the branches of
                auto* switch_instr = llvm::dyn_cast&lt;llvm::SwitchInst&gt;(&amp;instr);
                if (switch_instr != nullptr)
                {
                    for (uint64_t i = 0; i &lt; switch_instr-&gt;getNumSuccessors(); ++i)
                    {
                        auto bb = switch_instr-&gt;getSuccessor(static_cast&lt;uint32_t&gt;(i));
                        // Ensuring that we are not scheduling the same block twice
                        if (blocks_queued.find(bb) == blocks_queued.end())
                        {
                            queue.push_back(bb);
                            blocks_queued.insert(bb);
                        }
                    }
                    continue;
                }

                // Checking if this is an invoke call
                auto* invoke_inst = llvm::dyn_cast&lt;llvm::InvokeInst&gt;(&amp;instr);
                if (invoke_inst != nullptr)
                {
                    // Checking that configuration is correct
                    if (!config_.assumeNoExceptions())
                    {
                        // TODO(issue-20): Unify error reporting
                        throw std::runtime_error(&quot;Exceptions paths cannot be handled at compile time. Either disable &quot;
                                                 &quot;transform-execution-path-only or add assumption assume-no-except&quot;);
                    }

                    // Adding the block which is the on the &quot;no except&quot; path
                    auto bb = invoke_inst-&gt;getNormalDest();
                    if (blocks_queued.find(bb) == blocks_queued.end())
                    {
                        queue.push_back(bb);
                        blocks_queued.insert(bb);
                    }
                }
            }
        }

        // Deleting constants
        for (auto&amp; x : schedule_instruction_deletion)
        {
            x-&gt;eraseFromParent();
        }

        --depth_;

        return true;
    }

    bool TransformationRulesPass::isActive(llvm::Value* value) const
    {
        return active_pieces_.find(value) != active_pieces_.end();
    }

    void TransformationRulesPass::runCopyAndExpand(llvm::Module&amp; module, llvm::ModuleAnalysisManager&amp;)
    {
        replacements_.clear();
        // For every instruction in every block, we attempt a match
        // and replace.
        for (auto&amp; function : module)
        {
            if (function.hasFnAttribute(config_.entryPointAttr()))
            {
                runOnFunction(function, [this](llvm::Value* value, DeletableInstructions&amp; modifier) {
                    return copyAndExpand(value, modifier);
                });
            }
        }

        // Active code detection
        for (auto&amp; global : module.globals())
        {
            active_pieces_.insert(&amp;global);
            for (auto&amp; op : global.operands())
            {
                active_pieces_.insert(op);
            }
        }

        for (auto&amp; function : module)
        {
            bool is_active = false;

            // Checking if the function is referenced by a global variable
            for (auto user : function.users())
            {
                // If the user is active, then it should be expected that the function is also active
                if (isActive(user))
                {
                    is_active = true;
                    break;
                }
            }

            if (is_active || function.hasFnAttribute(config_.entryPointAttr()))
            {
                // Marking function as active
                active_pieces_.insert(&amp;function);

                // Detecting active code
                runOnFunction(function, [this](llvm::Value* value, DeletableInstructions&amp; modifier) {
                    return detectActiveCode(value, modifier);
                });
            }
        }

        processReplacements();
    }

    void TransformationRulesPass::processReplacements()
    {
        // Applying all replacements

        std::unordered_set&lt;llvm::Value*&gt; already_removed;
        for (auto it = replacements_.rbegin(); it != replacements_.rend(); ++it)
        {
            auto instr1 = llvm::dyn_cast&lt;llvm::Instruction&gt;(it-&gt;first);

            if (instr1 == nullptr)
            {
                llvm::outs() &lt;&lt; &quot;; WARNING: cannot deal with non-instruction replacements\n&quot;;
                continue;
            }

            // Checking if by accident the same instruction was added
            if (already_removed.find(instr1) != already_removed.end())
            {
                throw std::runtime_error(&quot;Instruction was already removed.&quot;);
            }
            already_removed.insert(instr1);

            // Cheking if have a replacement for the instruction
            if (it-&gt;second != nullptr)
            {
                // ... if so, we just replace it,
                auto instr2 = llvm::dyn_cast&lt;llvm::Instruction&gt;(it-&gt;second);
                if (instr2 == nullptr)
                {
                    llvm::outs() &lt;&lt; &quot;; WARNING: cannot replace instruction with non-instruction\n&quot;;
                    continue;
                }
                llvm::ReplaceInstWithInst(instr1, instr2);
            }
            else
            {
                // ... otherwise we delete the the instruction
                // Removing all uses
                if (!instr1-&gt;use_empty())
                {
                    auto type = instr1-&gt;getType();
                    if (type != nullptr)
                    {
                        instr1-&gt;replaceAllUsesWith(llvm::UndefValue::get(type));
                    }
                }

                // And finally we delete the instruction. The if statement
                // is first and foremost a precaution which prevents the program
                // from seg-faulting in the unlikely case that instr1-&gt;getType() is null.
                if (instr1-&gt;use_empty())
                {
                    instr1-&gt;eraseFromParent();
                }
            }
        }

        replacements_.clear();
    }

    void TransformationRulesPass::runDetectActiveCode(llvm::Module&amp; module, llvm::ModuleAnalysisManager&amp;)
    {
        blocks_to_delete_.clear();
        functions_to_delete_.clear();

        for (auto&amp; function : module)
        {
            if (isActive(&amp;function))
            {
                for (auto&amp; block : function)
                {
                    if (!isActive(&amp;block))
                    {
                        blocks_to_delete_.push_back(&amp;block);
                    }
                }
            }
            else if (!function.isDeclaration())
            {
                functions_to_delete_.push_back(&amp;function);
            }
        }
    }

    void TransformationRulesPass::runDeleteDeadCode(llvm::Module&amp;, llvm::ModuleAnalysisManager&amp;)
    {

        // Removing all function references and scheduling blocks for deletion
        for (auto&amp; function : functions_to_delete_)
        {
            // Schedule for deletion
            function-&gt;replaceAllUsesWith(llvm::UndefValue::get(function-&gt;getType()));

            function-&gt;clearGC();
            function-&gt;clearMetadata();

            // Deleteing blocks in reverse order
            std::vector&lt;llvm::BasicBlock*&gt; blocks;
            for (auto&amp; block : *function)
            {
                blocks.push_back(&amp;block);
            }

            // Removing backwards to avoid segfault
            for (auto it = blocks.rbegin(); it != blocks.rend(); ++it)
            {
                auto&amp; block = **it;
                // Deleting instructions in reverse order (needed because it is a DAG structure)
                std::vector&lt;llvm::Instruction*&gt; instructions;
                for (auto&amp; instr : block)
                {
                    instructions.push_back(&amp;instr);
                }

                // Removing all instructions
                for (auto it2 = instructions.rbegin(); it2 != instructions.rend(); ++it2)
                {
                    auto&amp; instr = **it2;
                    instr.replaceAllUsesWith(llvm::UndefValue::get(instr.getType()));
                    instr.eraseFromParent();
                }

                // Removing all block references
                block.replaceAllUsesWith(llvm::UndefValue::get(block.getType()));

                // Scheduling block deletion
                blocks_to_delete_.push_back(&amp;block);
            }
        }

        // Deleting all blocks
        for (auto block : blocks_to_delete_)
        {
            if (block-&gt;use_empty())
            {
                block-&gt;eraseFromParent();
            }
            else
            {
                llvm::errs() &lt;&lt; &quot;; INTERNAL ERROR: block was supposed to be unused.\n&quot;;
                for (auto&amp; x : block-&gt;uses())
                {
                    llvm::errs() &lt;&lt; &quot; -x &quot; &lt;&lt; *x &lt;&lt; &quot;\n&quot;;
                }
                for (auto x : block-&gt;users())
                {
                    llvm::errs() &lt;&lt; &quot; -: &quot; &lt;&lt; *x &lt;&lt; &quot;\n&quot;;
                }
                llvm::errs() &lt;&lt; &quot; ----- \n&quot;;
                llvm::errs() &lt;&lt; *block &lt;&lt; &quot;\n&quot;;
            }
        }

        // Removing functions
        for (auto&amp; function : functions_to_delete_)
        {
            if (function-&gt;isDeclaration() &amp;&amp; function-&gt;use_empty())
            {
                function-&gt;eraseFromParent();
            }
        }
    }

    void TransformationRulesPass::runReplacePhi(llvm::Module&amp; module, llvm::ModuleAnalysisManager&amp;)
    {
        using namespace microsoft::quantum::notation;
        auto                            rule = phi(&quot;b1&quot;_cap = _, &quot;b2&quot;_cap = _);
        IOperandPrototype::Captures     captures;
        std::vector&lt;llvm::Instruction*&gt; to_delete;

        std::unordered_map&lt;llvm::Instruction*, llvm::Value*&gt; replacements;

        for (auto&amp; function : module)
        {
            for (auto&amp; block : function)
            {
                std::vector&lt;llvm::Instruction*&gt; instrs;

                for (auto&amp; instr : block)
                {

                    if (rule-&gt;match(&amp;instr, captures))
                    {
                        auto phi = llvm::dyn_cast&lt;llvm::PHINode&gt;(&amp;instr);
                        if (phi == nullptr)
                        {
                            continue;
                        }

                        auto val1 = captures[&quot;b1&quot;];
                        auto val2 = captures[&quot;b2&quot;];

                        auto block1 = phi-&gt;getIncomingBlock(0); // TODO(issue-21): Make sure that block1 matches val1
                        auto block2 = phi-&gt;getIncomingBlock(1);

                        if (!isActive(block1))
                        {
                            val2-&gt;takeName(&amp;instr);

                            replacements[&amp;instr] = val2;

                            to_delete.push_back(&amp;instr);
                        }
                        else if (!isActive(block2))
                        {
                            val1-&gt;takeName(&amp;instr);

                            replacements[&amp;instr] = val2;
                            to_delete.push_back(&amp;instr);
                        }

                        captures.clear();
                    }
                }
            }
        }

        for (auto&amp; r : replacements)
        {
            r.first-&gt;replaceAllUsesWith(r.second);
        }

        for (auto&amp; x : to_delete)
        {
            x-&gt;eraseFromParent();
        }
    }

    void TransformationRulesPass::runApplyRules(llvm::Module&amp; module, llvm::ModuleAnalysisManager&amp;)
    {

        replacements_.clear();

        std::unordered_set&lt;llvm::Value*&gt; already_visited;
        for (auto&amp; function : module)
        {
            if (function.hasFnAttribute(config_.entryPointAttr()))
            {
                runOnFunction(function, [this, &amp;already_visited](llvm::Value* value, DeletableInstructions&amp;) {
                    auto instr = llvm::dyn_cast&lt;llvm::Instruction&gt;(value);

                    // Sanity check
                    if (already_visited.find(value) != already_visited.end())
                    {
                        throw std::runtime_error(&quot;Already visited&quot;);
                    }
                    already_visited.insert(value);

                    // Checking if we should analyse
                    if (instr != nullptr)
                    {
                        rule_set_.matchAndReplace(instr, replacements_);
                    }
                    return value;
                });

                if (config_.shouldAnnotateQubitUse())
                {
                    std::stringstream ss{&quot;&quot;};
                    ss &lt;&lt; profile_-&gt;getQubitAllocationManager()-&gt;maxAllocationsUsed();
                    function.addFnAttr(&quot;requiredQubits&quot;, ss.str());
                }

                if (config_.shouldAnnotateResultUse())
                {
                    std::stringstream ss{&quot;&quot;};
                    ss &lt;&lt; profile_-&gt;getResultAllocationManager()-&gt;maxAllocationsUsed();
                    function.addFnAttr(&quot;requiredResults&quot;, ss.str());
                }
            }
        }

        processReplacements();
    }

    llvm::PreservedAnalyses TransformationRulesPass::run(llvm::Module&amp; module, llvm::ModuleAnalysisManager&amp; mam)
    {
        // In case the module is istructed to clone functions,
        if (config_.shouldCloneFunctions())
        {
            setupCopyAndExpand();
            runCopyAndExpand(module, mam);
        }

        // Deleting dead code if configured to do so. This process consists
        // of three steps: detecting dead code, removing phi nodes (and references)
        // and finally deleting the code. This implementation is aggressive in the sense
        // that any code that we cannot prove to be active is considered dead.
        if (config_.shouldDeleteDeadCode())
        {
            runDetectActiveCode(module, mam);
            runReplacePhi(module, mam);
            runDeleteDeadCode(module, mam);
        }

        // Applying rule set
        if (config_.shouldTransformExecutionPathOnly())
        {
            // We only apply transformation rules to code which is reachable
            // via the execution path.
            runApplyRules(module, mam);
        }
        else
        {

            // Otherwise we apply to all sections of the code.
            replacements_.clear();
            for (auto&amp; function : module)
            {
                for (auto&amp; block : function)
                {
                    for (auto&amp; instr : block)
                    {
                        rule_set_.matchAndReplace(&amp;instr, replacements_);
                    }
                }
            }

            processReplacements();
        }

        return llvm::PreservedAnalyses::none();
    }

    llvm::Function* TransformationRulesPass::expandFunctionCall(
        llvm::Function&amp;          callee,
        ConstantArguments const&amp; const_args)
    {
        auto              module  = callee.getParent();
        auto&amp;             context = module-&gt;getContext();
        llvm::IRBuilder&lt;&gt; builder(context);

        // Copying the original function
        llvm::ValueToValueMapTy  remapper;
        std::vector&lt;llvm::Type*&gt; arg_types;

        // The user might be deleting arguments to the function by specifying them in
        // the VMap.  If so, we need to not add the arguments to the arg ty vector
        //
        for (auto const&amp; arg : callee.args())
        {
            // Skipping constant arguments

            if (const_args.find(arg.getName().str()) != const_args.end())
            {
                continue;
            }

            arg_types.push_back(arg.getType());
        }

        // Creating a new function
        llvm::FunctionType* function_type = llvm::FunctionType::get(
            callee.getFunctionType()-&gt;getReturnType(), arg_types, callee.getFunctionType()-&gt;isVarArg());
        auto function = llvm::Function::Create(
            function_type, callee.getLinkage(), callee.getAddressSpace(), callee.getName(), module);

        // Copying the non-const arguments
        auto dest_args_it = function-&gt;arg_begin();

        for (auto const&amp; arg : callee.args())
        {
            auto const_it = const_args.find(arg.getName().str());
            if (const_it == const_args.end())
            {
                // Mapping remaining function arguments
                dest_args_it-&gt;setName(arg.getName());
                remapper[&amp;arg] = &amp;*dest_args_it++;
            }
            else
            {
                remapper[&amp;arg] = llvm::ConstantInt::get(context, const_it-&gt;second-&gt;getValue());
            }
        }

        llvm::SmallVector&lt;llvm::ReturnInst*, 8&gt; returns; // Ignore returns cloned.

        // Note: In LLVM 13 upgrade 'true' to 'llvm::CloneFunctionChangeType::LocalChangesOnly'
        llvm::CloneFunctionInto(function, &amp;callee, remapper, true, returns, &quot;&quot;, nullptr);

        verifyFunction(*function);

        return function;
    }

    void TransformationRulesPass::setLogger(ILoggerPtr logger)
    {
        logger_ = std::move(logger);
    }

    bool TransformationRulesPass::isRequired()
    {
        return true;
    }

} // namespace quantum
} // namespace microsoft
</code></pre>
<hr />
<p>Updated on 22 November 2021 at 12:38:16 UTC</p>
  </div>
</div>

          </div>
        </main>

      </div>
    </div>
    <script>
      var base_url = "../../..",
          shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
    </script>
    <script src="../../../js/base.js" defer></script>
    <script src="../../../search/main.js" defer></script>  
  </body>

</html>
